# Production Deployment Guide

This guide provides detailed instructions for deploying the Multi-Tenant Document Management System to production on Render.com.

## Prerequisites

Before deploying to production, ensure you have:
- GitHub repository with the latest code
- Render.com account (free tier is sufficient)
- AWS account with S3 access credentials
- Groq API key for AI features
- Neon database account and API key
- Email service credentials (Gmail App Password recommended)

## Environment Configuration

### Critical Production Settings

The most important configuration for production is setting the `ENVIRONMENT` variable correctly. This controls CORS behavior and security settings.

## Backend Deployment

### Step 1: Create Backend Service on Render

1. Log in to [Render.com](https://render.com)
2. Click "New +" → "Web Service"
3. Connect your GitHub repository
4. Configure the service:
   - **Name**: `multitenant-backend` (or your preferred name)
   - **Branch**: `main` or `development`
   - **Root Directory**: `backend`
   - **Environment**: Python 3
   - **Build Command**: 
     ```bash
     pip install -r requirements.txt && python -m spacy download en_core_web_sm
     ```
   - **Start Command**:
     ```bash
     uvicorn app.main:app --host 0.0.0.0 --port $PORT
     ```

### Step 2: Configure Environment Variables

In the Render dashboard for your backend service, go to "Environment" and add these variables:

#### Required Variables

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `ENVIRONMENT` | **MUST be set to `production`** | `production` |
| `SECRET_KEY` | JWT signing key | Generate with `openssl rand -hex 32` |
| `ALGORITHM` | JWT algorithm | `HS256` |
| `ACCESS_TOKEN_EXPIRE_MINUTES` | Token expiration | `30` |

#### Database Configuration

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `DATABASE_URL` | PostgreSQL connection string | Auto-generated by Render |
| `MANAGEMENT_DATABASE_URL` | Management database URL | Same as DATABASE_URL |
| `NEON_API_KEY` | Neon API key | From neon.tech dashboard |
| `NEON_PROJECT_ID` | Neon project ID | From neon.tech dashboard |

#### AWS S3 Configuration

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `AWS_ACCESS_KEY_ID` | AWS access key | From AWS IAM |
| `AWS_SECRET_ACCESS_KEY` | AWS secret key | From AWS IAM |
| `AWS_REGION` | AWS region | `us-east-1` |

#### AI Services

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `GROQ_API_KEY` | Groq API key | From groq.com |
| `GROQ_MODEL` | AI model to use | `qwen/qwen3-32b` |

#### Email Configuration

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `SMTP_SERVER` | Email server | `smtp.gmail.com` |
| `SMTP_PORT` | SMTP port | `587` |
| `SENDER_EMAIL` | Sender email address | Your email |
| `SENDER_PASSWORD` | Email password | Gmail App Password |
| `SENDER_NAME` | Sender display name | `Document Management System` |

#### Application Settings

| Variable | Description | Example/Notes |
|----------|-------------|---------------|
| `APP_URL` | Frontend URL | `https://multitenant-frontend.onrender.com` |
| `ENABLE_EMAIL_NOTIFICATIONS` | Enable email features | `true` |
| `ENABLE_DOCUMENT_NOTIFICATIONS` | Document notifications | `true` |
| `ENABLE_ESIGNATURE_NOTIFICATIONS` | E-signature notifications | `true` |

### Step 3: Create PostgreSQL Database

1. In Render dashboard, click "New +" → "PostgreSQL"
2. Configure the database:
   - **Name**: `multitenant-db`
   - **Database**: Leave as default
   - **User**: Leave as default
   - **Region**: Same as your backend service
3. After creation, the `DATABASE_URL` will be automatically available
4. Copy this URL and set both `DATABASE_URL` and `MANAGEMENT_DATABASE_URL` to this value in your backend environment variables

## Frontend Deployment

### Step 1: Create Frontend Static Site

1. In Render dashboard, click "New +" → "Static Site"
2. Connect the same GitHub repository
3. Configure the site:
   - **Name**: `multitenant-frontend`
   - **Branch**: Same as backend
   - **Root Directory**: `frontend`
   - **Build Command**: 
     ```bash
     npm install && npm run build
     ```
   - **Publish Directory**: `build`

### Step 2: Configure Frontend Environment Variables

Add these environment variables to the frontend static site:

| Variable | Value | Description |
|----------|-------|-------------|
| `REACT_APP_API_URL` | `https://your-backend-name.onrender.com` | Your backend URL |
| `CI` | `false` | Prevents build warnings from failing deployment |

## Post-Deployment Configuration

### Step 1: Verify Services

1. **Check Backend Health**:
   ```bash
   curl https://your-backend.onrender.com/health
   ```

2. **Check System Status**:
   ```bash
   curl https://your-backend.onrender.com/api/system/status
   ```

### Step 2: Initialize System Admin

Create the first system administrator:

```bash
curl -X POST https://your-backend.onrender.com/init-admin
```

Save the returned credentials securely.

### Step 3: Test CORS Configuration

Verify CORS is working correctly:

```bash
curl -X OPTIONS "https://your-backend.onrender.com/api/companies" \
  -H "Origin: https://your-frontend.onrender.com" \
  -H "Access-Control-Request-Method: GET" \
  -v
```

You should see `Access-Control-Allow-Origin: https://your-frontend.onrender.com` in the response headers.

## Troubleshooting

### CORS Errors

**Symptom**: Browser console shows CORS errors with mismatched origins

**Common Causes & Solutions**:

1. **Wrong ENVIRONMENT Setting**:
   - Verify `ENVIRONMENT=production` is set in backend
   - Check for typos (e.g., "Production" instead of "production")
   - Restart backend service after changing

2. **Cached Configuration**:
   - Clear browser cache
   - Try incognito/private browsing mode
   - Restart backend service on Render

3. **Frontend URL Mismatch**:
   - Ensure frontend URL exactly matches what's in CORS configuration
   - Check for trailing slashes or protocol differences

### Database Connection Issues

**Symptom**: "Database connection failed" errors

**Solutions**:
1. Verify `DATABASE_URL` is set correctly
2. Ensure `MANAGEMENT_DATABASE_URL` is set (same value as DATABASE_URL)
3. Check if database is active (free tier databases may sleep)
4. Verify Neon API credentials if using Neon for company databases

### Authentication Failures

**Symptom**: "Invalid token" or login failures

**Solutions**:
1. Ensure `SECRET_KEY` is set and hasn't changed
2. Verify `ALGORITHM` is set to `HS256`
3. Check token expiration settings
4. Ensure frontend is sending Authorization header correctly

### Email Service Issues

**Symptom**: Emails not sending

**Solutions**:
1. For Gmail: Use App Password, not regular password
2. Enable 2FA on Gmail account first
3. Check SMTP settings match your provider
4. Verify sender email is correct
5. Check spam folder for test emails

## Security Checklist

Before going live with production:

- [ ] Generate strong `SECRET_KEY` using cryptographic randomness
- [ ] Set `ENVIRONMENT=production` to enable security features
- [ ] Use HTTPS for both frontend and backend (Render provides this)
- [ ] Secure all API keys and passwords
- [ ] Enable 2FA on all service accounts (AWS, Gmail, etc.)
- [ ] Review and restrict AWS IAM permissions
- [ ] Set up monitoring and alerts
- [ ] Configure backup strategy for database
- [ ] Test disaster recovery procedures
- [ ] Document all environment variables securely

## Monitoring & Maintenance

### Health Checks

Set up monitoring for these endpoints:
- Backend: `https://your-backend.onrender.com/health`
- System Status: `https://your-backend.onrender.com/api/system/status`
- Frontend: `https://your-frontend.onrender.com`

### Database Maintenance

For Render free tier:
- Databases expire after 90 days of inactivity
- Set up regular backups using pg_dump
- Monitor storage usage (1GB limit on free tier)

### Service Limits

Render free tier limitations:
- 750 hours/month for web services
- Services spin down after 15 minutes of inactivity
- First request after spin-down may be slow
- Consider upgrading for production use

## Updating Production

### Code Updates

1. Push changes to your configured branch
2. Render will automatically rebuild and deploy
3. Monitor deployment logs in Render dashboard
4. Test functionality after deployment completes

### Environment Variable Updates

1. Update variables in Render dashboard
2. Restart the service to apply changes
3. Some variables (like CORS settings) require restart

### Database Migrations

1. Test migrations locally first
2. Backup production database
3. Run migrations during low-traffic period
4. Have rollback plan ready

## Support & Resources

- [Render Documentation](https://render.com/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [React Documentation](https://reactjs.org/docs)
- [Project Repository](https://github.com/your-username/multitenant-document-management)

## Quick Reference

### Production URLs (Update with your actual URLs)
- Backend API: `https://multitenant-backend.onrender.com`
- Frontend: `https://multitenant-frontend.onrender.com`
- API Documentation: `https://multitenant-backend.onrender.com/docs`
- Health Check: `https://multitenant-backend.onrender.com/health`

### Emergency Procedures

#### Backend Not Responding
1. Check Render service logs
2. Restart service from Render dashboard
3. Verify environment variables
4. Check database connection

#### CORS Errors After Deployment
1. Verify `ENVIRONMENT=production`
2. Clear browser cache
3. Restart backend service
4. Test with curl command

#### Database Issues
1. Check connection string
2. Verify database is active
3. Check Neon API status
4. Review database logs

Remember: The most common production issue is forgetting to set `ENVIRONMENT=production` in the backend environment variables!